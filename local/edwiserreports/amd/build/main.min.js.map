{"version":3,"sources":["main.js"],"names":["define","$","ModalFactory","Notification","EdwiserReportsEvents","common","email","CFG","insights","Migration","siteAccess","activeCourses","activeUsers","courseProgress","inactiveUsers","realTimeUsers","todaysActivity","grade","visitsonsite","timespentonsite","timespentoncourse","courseactivitystatus","learnercourseprogress","learnertimespentonsite","courseengagement","certificatestats","SELECTOR","ROOT","EXPORT","DATESELECTED","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","PROMISE","GET_TIMEPERIOD_LABEL","timeperiod","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","GET_EXPORT_DATA_FOR_GRAPH","download","blocks","flatpickr","validateUser","blockid","response","concat","html","exception","message","showTimeLabel","date","done","startdate","Date","enddate","startDay","getDate","endDay","toLocaleString","month","getFullYear","fail","ex","throwDateEvent","label","dateChangeEvent","CustomEvent","DATECHANGE","detail","document","dispatchEvent","init","ready","currentDate","text","handleSearchInput","forEach","block","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","dropdown","onClose","dateAlternate","removeClass","val","next","replace","includes","clear","on","this","exportDropdownHandler","initMigration","create","TYPE","format","filename","require","amd"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>\n * @author      Yogesh Shirsath\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/modal_factory',\n    'core/notification',\n    './events',\n    './common',\n    './email',\n    './defaultconfig',\n    './insights',\n    './modal-migration',\n    './blocks/siteaccess',\n    './blocks/activecourses',\n    './blocks/activeusers',\n    './blocks/courseprogress',\n    './blocks/inactiveusers',\n    './blocks/realtimeusers',\n    './blocks/todaysactivity',\n    './blocks/grade',\n    './blocks/visitsonsite',\n    './blocks/timespentonsite',\n    './blocks/timespentoncourse',\n    './blocks/courseactivitystatus',\n    './blocks/learnercourseprogress',\n    './blocks/learnertimespentonsite',\n    './blocks/courseengagement',\n    './blocks/certificatestats'\n], function(\n    $,\n    ModalFactory,\n    Notification,\n    EdwiserReportsEvents,\n    common,\n    email,\n    CFG,\n    insights,\n    Migration,\n    siteAccess,\n    activeCourses,\n    activeUsers,\n    courseProgress,\n    inactiveUsers,\n    realTimeUsers,\n    todaysActivity,\n    grade,\n    visitsonsite,\n    timespentonsite,\n    timespentoncourse,\n    courseactivitystatus,\n    learnercourseprogress,\n    learnertimespentonsite,\n    courseengagement,\n    certificatestats\n) {\n\n    /**\n     * Selector list.\n     */\n    var SELECTOR = {\n        ROOT: '#wdm-edwiserreports',\n        EXPORT: '#wdm-edwiserreports .export-options',\n        DATESELECTED: '.selected-period',\n        DATE: '.edwiserreports-header .edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Promises.\n     */\n    var PROMISE = {\n        /**\n         * Get time period label to show in the header.\n         * @param {String} timeperiod Time period.\n         * @returns {Promise}\n         */\n        GET_TIMEPERIOD_LABEL: function(timeperiod) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_timeperiod_label_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: timeperiod\n                }\n            });\n        },\n\n        /**\n         * Get data for graph export using download key.\n         * @param {String} download Download key for graph records\n         * @returns {Promise}\n         */\n        GET_EXPORT_DATA_FOR_GRAPH: function(download) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_export_data_for_graph',\n                    lang: $('html').attr('lang'),\n                    download: download\n                }\n            })\n        }\n    };\n\n    /**\n     * Blocks list.\n     */\n    var blocks = [\n        siteAccess,\n        activeCourses,\n        activeUsers,\n        courseProgress,\n        inactiveUsers,\n        realTimeUsers,\n        todaysActivity,\n        grade,\n        visitsonsite,\n        timespentonsite,\n        timespentoncourse,\n        courseactivitystatus,\n        learnercourseprogress,\n        learnertimespentonsite,\n        courseengagement,\n        certificatestats\n    ];\n\n    /**\n     * Flat picker custom date.\n     */\n    let flatpickr = null;\n\n    /**\n     * This function will show validation error in block card.\n     * @param {String} blockid Block id\n     * @param {Object} response User validation response\n     */\n    function validateUser(blockid, response) {\n        $(`#${blockid} .panel-body`).html(response.exception.message);\n    }\n\n    /**\n     * Show time duration in header.\n     * @param {String} date Time period.\n     */\n    function showTimeLabel(date) {\n        PROMISE.GET_TIMEPERIOD_LABEL(date).done(function(response) {\n            let startdate = new Date(response.startdate * 86400000);\n            let enddate = new Date(response.enddate * 86400000);\n            let startDay = startdate.getDate();\n            startDay = startDay < 10 ? '0' + startDay : startDay;\n            let endDay = enddate.getDate();\n            endDay = endDay < 10 ? '0' + endDay : endDay;\n            $(SELECTOR.DATESELECTED).html('<div style=\"display:flex;\"><div>' + `\n            ${startDay} ${startdate.toLocaleString('default', { month: 'long' })} ${startdate.getFullYear()}` + '</div> - <div>' +\n            `${endDay} ${enddate.toLocaleString('default', { month: 'long' })} ${enddate.getFullYear()}` + '</div></div>');\n\n            // $(SELECTOR.DATESELECTED).html('<div style=\"display:flex;\"><div>' + `${startDay} ${startdate.toLocaleString('default', { month: 'long' })} ${startdate.getFullYear()}` + '</div> - <div>' +\n            // `${endDay} ${enddate.toLocaleString('default', { month: 'long' })} ${enddate.getFullYear()}` + '</div></div>');\n\n        }).fail(function(ex) {\n            Notification.exception(ex);\n        });\n    }\n\n    /**\n     * Throw an event with date change data.\n     * @param {String} date  Date\n     * @param {String} label Date label\n     */\n    function throwDateEvent(date, label) {\n        let dateChangeEvent = new CustomEvent(EdwiserReportsEvents.DATECHANGE, {\n            detail: {\n                date: date\n            }\n        });\n        document.dispatchEvent(dateChangeEvent);\n        showTimeLabel(date, label);\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // d M Y format\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        // Throw date change event.\n        throwDateEvent(date, dateAlternate);\n    }\n\n    /**\n     * Init main.js\n     */\n    var init = function() {\n        $(document).ready(function() {\n\n            // Initialize schedule email modal.\n            email.init();\n\n            // Initialize insights.\n            insights.init();\n\n            let currentDate = $(SELECTOR.DATEITEM + '.active').data('value');\n\n            // Show time period in header.\n            showTimeLabel(\n                currentDate,\n                $(SELECTOR.DATEITEM + '.active').text()\n            );\n\n            common.handleSearchInput();\n\n            blocks.forEach(block => {\n                block.init(validateUser, currentDate);\n            });\n\n            flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d M Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: $(SELECTOR.DATEPICKER).get(0),\n                onOpen: function() {\n                    $(SELECTOR.DATEMENU).addClass('withcalendar');\n                    $(SELECTOR.DATE).dropdown('update');\n                },\n                onClose: function() {\n                    $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                    customDateSelected();\n                }\n            });\n\n            /* Date selector listener */\n            $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n                // Set custom selected item as active.\n                $(SELECTOR.DATEITEM).removeClass('active');\n                $(this).addClass('active');\n\n                // Show selected item on dropdown button.\n                $(SELECTOR.DATE).html($(this).text());\n\n                // Clear custom date.\n                flatpickr.clear();\n\n                // Throw date change event.\n                throwDateEvent($(this).data('value'), $(this).text());\n            });\n\n            common.exportDropdownHandler(SELECTOR.EXPORT);\n        });\n    };\n\n    function initMigration() {\n        ModalFactory.create({\n            type: Migration.TYPE\n        }, $('#create'));\n    }\n\n    /**\n     * Download graph as image.\n     * @param {String} download Download key\n     * @param {String} block    Block name\n     * @param {String} format   Exporting format\n     * @param {String} filename Exporting filename\n     */\n    function download(download, block, format, filename) {\n        $(document).ready(function() {\n            require(['local_edwiserreports/blocks/' + block], function(amd) {\n                PROMISE.GET_EXPORT_DATA_FOR_GRAPH(download)\n                    .done(function(response) {\n                        amd.download(format, filename, response);\n                    });\n            });\n        });\n    }\n\n    // Must return the init function\n    return {\n        init: init,\n        initMigration: initMigration,\n        download: download\n    };\n});\n"],"file":"main.min.js"}
